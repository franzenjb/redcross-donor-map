<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>American Red Cross Donor Map</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --red-cross-primary: #ED1B2E;
            --red-cross-secondary: #B31E29;
            --red-cross-dark: #8B1A1E;
            --red-cross-gray: #6D6E70;
            --red-cross-light-gray: #D7D7D8;
            --red-cross-white: #FFFFFF;
            --red-cross-black: #231F20;
            
            /* Light mode (default) */
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-header: linear-gradient(135deg, #ED1B2E 0%, #B31E29 100%);
            --text-primary: #231F20;
            --text-secondary: #6D6E70;
            --border-color: #ddd;
            --shadow: rgba(0,0,0,0.1);
            --map-style: 'carto-positron';
        }
        
        [data-theme="dark"] {
            /* Dark mode */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-header: linear-gradient(135deg, #8B1A1E 0%, #4A0E0E 100%);
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
            --shadow: rgba(0,0,0,0.3);
            --map-style: 'carto-darkmatter';
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Open Sans', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: var(--bg-header);
            color: white;
            padding: 10px 20px;
            box-shadow: 0 2px 10px var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            transition: background 0.3s ease;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .red-cross-logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: var(--red-cross-primary);
            font-weight: bold;
        }
        
        h1 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        .main-content {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }
        
        .sidebar {
            width: 350px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .map-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .controls-panel {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: var(--red-cross-gray);
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select, input {
            padding: 10px 12px;
            border: 2px solid var(--red-cross-light-gray);
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        select:hover, input:hover {
            border-color: var(--red-cross-primary);
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--red-cross-primary);
            box-shadow: 0 0 0 3px rgba(237, 27, 46, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 24px;
            background: var(--red-cross-primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background: var(--red-cross-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(237, 27, 46, 0.3);
        }
        
        button.secondary {
            background: white;
            color: var(--red-cross-primary);
            border: 2px solid var(--red-cross-primary);
        }
        
        button.secondary:hover {
            background: var(--red-cross-primary);
            color: white;
        }
        
        .map-type-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .map-type-btn {
            padding: 10px 15px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 13px;
            text-align: left;
        }
        
        .map-type-btn.active {
            background: var(--red-cross-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(237, 27, 46, 0.4);
        }
        
        .map-type-btn:hover:not(.active) {
            background: #5a6f8a;
        }
        
        #leaflet-map {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .location-counter {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
        }
        
        .cluster-icon {
            background: #ED1B2E;
            border: 3px solid #27ae60;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .stats-grid {
            padding: 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }
        
        .stat-card {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .stat-card:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--red-cross-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--red-cross-primary);
        }
        
        .map-container {
            flex: 1;
            position: relative;
            background: #f5f5f5;
        }
        
        .zoom-controls {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .zoom-btn:hover {
            background: var(--red-cross-primary);
            color: white;
            border-color: var(--red-cross-primary);
            transform: scale(1.1);
        }
        
        .zoom-btn:active {
            transform: scale(0.95);
        }
        
        .zoom-reset {
            font-size: 14px;
            padding: 8px 12px;
            width: auto;
            height: auto;
            margin-top: 5px;
        }
        
        .zoom-info {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .theme-toggle {
            margin-left: auto;
            margin-right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 30px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .theme-icon {
            transition: transform 0.3s ease;
        }
        
        [data-theme="dark"] .theme-icon.sun {
            transform: rotate(180deg);
            opacity: 0;
        }
        
        [data-theme="dark"] .theme-icon.moon {
            transform: rotate(0deg);
            opacity: 1;
        }
        
        .theme-icon.sun {
            position: absolute;
        }
        
        .theme-icon.moon {
            opacity: 0;
        }
        
        #plotly-map {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loading.show {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--red-cross-light-gray);
            border-top-color: var(--red-cross-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--red-cross-primary);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--red-cross-light-gray);
            padding-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <header class="header">
        <div class="logo-section">
            <div class="red-cross-logo">✚</div>
            <h1>American Red Cross Donor Map</h1>
        </div>
        <div style="margin-left: auto; font-size: 12px; opacity: 0.9;">
            Interactive Visualization • 10,000+ Donors
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
            <span class="theme-icon sun">☀️</span>
            <span class="theme-icon moon">🌙</span>
        </button>
    </header>
    
    <div class="main-content">
        <div class="sidebar">
            <div class="map-type-buttons">
                <button class="map-type-btn active" data-type="leaflet">🗺️ Leaflet Clusters</button>
                <button class="map-type-btn" data-type="mapbox-points">📍 Mapbox Points</button>
                <button class="map-type-btn" data-type="heatmap">🔥 Heat Map</button>
                <button class="map-type-btn" data-type="choropleth">🇺🇸 State Choropleth</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Donors</div>
                    <div class="stat-value" id="total-donors">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Donations</div>
                    <div class="stat-value" id="total-gifts">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Gift</div>
                    <div class="stat-value" id="avg-gift">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Median Gift</div>
                    <div class="stat-value" id="median-gift">-</div>
                </div>
            </div>
            
            <div class="controls-panel">
                <h3 style="margin: 0 0 15px 0; font-size: 14px; color: var(--red-cross-primary);">FILTERS</h3>
                <div class="controls-grid">
                <div class="control-group">
                    <label for="state-filter">State</label>
                    <select id="state-filter">
                        <option value="all">All States</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="city-filter">City</label>
                    <select id="city-filter">
                        <option value="all">All Cities</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="gift-category">Gift Category</label>
                    <select id="gift-category">
                        <option value="all">All Categories</option>
                        <option value="$5K">$5K</option>
                        <option value="$5K-7.5K">$5K-7.5K</option>
                        <option value="$7.5K-10K">$7.5K-10K</option>
                        <option value="$10K-15K">$10K-15K</option>
                        <option value="$15K-25K">$15K-25K</option>
                        <option value="$25K-50K">$25K-50K</option>
                        <option value="$50K-100K">$50K-100K</option>
                        <option value=">$100K">>$100K</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="min-gift">Minimum Gift ($)</label>
                    <input type="number" id="min-gift" placeholder="5000" min="5000" value="5000">
                </div>
                
                <div class="control-group">
                    <label for="max-gift">Maximum Gift ($)</label>
                    <input type="number" id="max-gift" placeholder="No limit" min="5000">
                </div>
            </div>
            
                <div class="button-group">
                    <button onclick="applyFilters()">Apply Filters</button>
                    <button class="secondary" onclick="resetFilters()">Reset All</button>
                </div>
            </div>
        </div>
        
        <div class="map-section">
            <div class="map-container">
            <div class="zoom-controls" id="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">−</button>
                <button class="zoom-btn zoom-reset" onclick="resetZoom()">Reset</button>
            </div>
            <div class="zoom-info" id="zoom-info">
                💡 Tip: Double-click to zoom in • Shift + Double-click to zoom out
            </div>
            <div id="plotly-map"></div>
            <div id="leaflet-map"></div>
            <div class="location-counter" id="location-counter" style="display: none;">
                Showing <span id="location-count">0</span> locations
            </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentMapType = 'leaflet';
        let currentFilters = {};
        let allData = [];
        let processedData = [];
        let leafletMap = null;
        let leafletMarkers = null;
        let currentZoom = 4;
        let currentCenter = {lat: 39.8283, lon: -98.5795}; // Center of continental US
        let mapBounds = null;
        let initialLoad = true;
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // Initialize theme on page load
        document.documentElement.setAttribute('data-theme', currentTheme);
        
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            
            // Update map styles
            updateMapTheme();
        }
        
        function updateMapTheme() {
            const mapStyle = currentTheme === 'dark' ? 'carto-darkmatter' : 'carto-positron';
            
            // Update Leaflet map if it exists
            if (leafletMap && currentMapType === 'leaflet') {
                // Remove old tile layer
                leafletMap.eachLayer(function(layer) {
                    if (layer instanceof L.TileLayer) {
                        leafletMap.removeLayer(layer);
                    }
                });
                
                // Add new tile layer with appropriate theme
                const tileUrl = currentTheme === 'dark' 
                    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                    : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                
                L.tileLayer(tileUrl, {
                    attribution: '© OpenStreetMap contributors © CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(leafletMap);
            }
            
            // Refresh current Plotly map if needed
            if (currentMapType !== 'leaflet' && currentMapType !== 'choropleth') {
                const filteredData = getFilteredData();
                updateMap(filteredData);
            }
        }
        
        function getFilteredData() {
            // This will be called to get the currently filtered dataset
            return processedData; // For now, return all processed data
        }
        
        const RED_CROSS_COLORS = {
            primary_red: '#ED1B2E',
            secondary_red: '#B31E29',
            dark_red: '#8B1A1E',
            gray: '#6D6E70',
            light_gray: '#D7D7D8',
            white: '#FFFFFF',
            black: '#231F20'
        };
        
        const GIFT_COLORS = {
            '$5K': '#FFE6E8',
            '$5K-7.5K': '#FFB3B8',
            '$7.5K-10K': '#FF8088',
            '$10K-15K': '#FF4D58',
            '$15K-25K': '#ED1B2E',
            '$25K-50K': '#B31E29',
            '$50K-100K': '#8B1A1E',
            '>$100K': '#4A0E0E'
        };
        
        document.querySelectorAll('.map-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.map-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentMapType = this.dataset.type;
                applyFilters();
            });
        });
        
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
        
        function parseGiftAmount(gift) {
            if (typeof gift === 'string') {
                return parseFloat(gift.replace('$', '').replace(/,/g, '').trim());
            }
            return parseFloat(gift) || 0;
        }
        
        function getGiftCategory(amount) {
            if (amount <= 5000) return '$5K';
            if (amount <= 7500) return '$5K-7.5K';
            if (amount <= 10000) return '$7.5K-10K';
            if (amount <= 15000) return '$10K-15K';
            if (amount <= 25000) return '$15K-25K';
            if (amount <= 50000) return '$25K-50K';
            if (amount <= 100000) return '$50K-100K';
            return '>$100K';
        }
        
        function loadCSVData() {
            showLoading();
            Papa.parse('data/donors.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    allData = results.data.filter(row => {
                        const gift = parseGiftAmount(row[' Gift $ ']);
                        const lat = parseFloat(row.Y);
                        const lon = parseFloat(row.X);
                        // Filter out territories - keep only continental US and nearby
                        // Excludes: Guam (~13°N, 144°E), Puerto Rico (~18°N, -66°W), Hawaii (~21°N, -157°W), Alaska (~64°N, -152°W)
                        const isContiguousUS = lat > 24 && lat < 50 && lon > -125 && lon < -66;
                        return !isNaN(gift) && gift > 0 && row.X && row.Y && isContiguousUS;
                    });
                    
                    processedData = allData.map(row => {
                        const gift = parseGiftAmount(row[' Gift $ ']);
                        return {
                            ...row,
                            gift_amount: gift,
                            gift_category: getGiftCategory(gift),
                            state: row.State || row['Region Abbreviation'] || '',
                            city: row['City.1'] || row.City || row['ARC Best City'] || '',
                            lon: parseFloat(row.X),
                            lat: parseFloat(row.Y)
                        };
                    });
                    
                    populateFilters();
                    applyFilters();
                    hideLoading();
                }
            });
        }
        
        function populateFilters() {
            const states = [...new Set(processedData.map(d => d.state).filter(s => s))].sort();
            const stateSelect = document.getElementById('state-filter');
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
        }
        
        function applyFilters() {
            showLoading();
            
            let filtered = [...processedData];
            
            const state = document.getElementById('state-filter').value;
            if (state && state !== 'all') {
                filtered = filtered.filter(d => d.state === state);
            }
            
            const city = document.getElementById('city-filter').value;
            if (city && city !== 'all') {
                filtered = filtered.filter(d => d.city === city);
            }
            
            const category = document.getElementById('gift-category').value;
            if (category && category !== 'all') {
                filtered = filtered.filter(d => d.gift_category === category);
            }
            
            const minGift = parseFloat(document.getElementById('min-gift').value) || 5000;
            const maxGift = parseFloat(document.getElementById('max-gift').value) || Infinity;
            filtered = filtered.filter(d => d.gift_amount >= minGift && d.gift_amount <= maxGift);
            
            updateCityFilter(filtered);
            updateStats(filtered);
            updateMap(filtered);
            updateCharts(filtered);
            
            hideLoading();
        }
        
        function updateCityFilter(data) {
            const cities = [...new Set(data.map(d => d.city).filter(c => c))].sort();
            const citySelect = document.getElementById('city-filter');
            const currentCity = citySelect.value;
            
            citySelect.innerHTML = '<option value="all">All Cities</option>';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                if (city === currentCity) option.selected = true;
                citySelect.appendChild(option);
            });
        }
        
        function updateStats(data) {
            const total = data.reduce((sum, d) => sum + d.gift_amount, 0);
            const avg = total / data.length || 0;
            const sorted = [...data].sort((a, b) => a.gift_amount - b.gift_amount);
            const median = sorted.length ? sorted[Math.floor(sorted.length / 2)].gift_amount : 0;
            
            document.getElementById('total-donors').textContent = data.length.toLocaleString();
            document.getElementById('total-gifts').textContent = '$' + total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('avg-gift').textContent = '$' + avg.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('median-gift').textContent = '$' + median.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        function updateMap(data) {
            // Update location counter
            document.getElementById('location-count').textContent = data.length.toLocaleString();
            
            // Calculate bounds if we have data
            if (data.length > 0) {
                const lats = data.map(d => d.lat).filter(lat => lat && !isNaN(lat));
                const lons = data.map(d => d.lon).filter(lon => lon && !isNaN(lon));
                
                if (lats.length > 0 && lons.length > 0) {
                    mapBounds = {
                        minLat: Math.min(...lats),
                        maxLat: Math.max(...lats),
                        minLon: Math.min(...lons),
                        maxLon: Math.max(...lons)
                    };
                    
                    // Only update center if it makes sense (US bounds roughly)
                    const calculatedLat = (mapBounds.minLat + mapBounds.maxLat) / 2;
                    const calculatedLon = (mapBounds.minLon + mapBounds.maxLon) / 2;
                    
                    // Check if calculated center is within reasonable US bounds
                    if (calculatedLat > 20 && calculatedLat < 50 && 
                        calculatedLon > -130 && calculatedLon < -60) {
                        currentCenter = {
                            lat: calculatedLat,
                            lon: calculatedLon
                        };
                    }
                    
                    // Set appropriate zoom for initial load
                    if (initialLoad) {
                        const latDiff = mapBounds.maxLat - mapBounds.minLat;
                        const lonDiff = mapBounds.maxLon - mapBounds.minLon;
                        const maxDiff = Math.max(latDiff, lonDiff);
                        
                        if (maxDiff > 40) currentZoom = 3;
                        else if (maxDiff > 20) currentZoom = 4;
                        else if (maxDiff > 10) currentZoom = 5;
                        else currentZoom = 6;
                        
                        initialLoad = false;
                    }
                }
            }
            
            // Hide all maps first
            document.getElementById('plotly-map').style.display = 'block';
            document.getElementById('leaflet-map').style.display = 'none';
            document.getElementById('location-counter').style.display = 'none';
            document.getElementById('zoom-controls').style.display = 'flex';
            document.getElementById('zoom-info').style.display = 'block';
            
            if (currentMapType === 'leaflet') {
                document.getElementById('plotly-map').style.display = 'none';
                document.getElementById('leaflet-map').style.display = 'block';
                document.getElementById('location-counter').style.display = 'block';
                document.getElementById('zoom-controls').style.display = 'none';
                document.getElementById('zoom-info').style.display = 'none';
                createLeafletMap(data);
            } else if (currentMapType === 'mapbox-points') {
                createPointMap(data);
            } else if (currentMapType === 'heatmap') {
                createHeatmap(data);
            } else if (currentMapType === 'choropleth') {
                document.getElementById('zoom-controls').style.display = 'none';
                document.getElementById('zoom-info').style.display = 'none';
                createChoropleth(data);
            }
        }
        
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 1, 18);
            updatePlotlyZoom();
        }
        
        function zoomOut() {
            currentZoom = Math.max(currentZoom - 1, 1);
            updatePlotlyZoom();
        }
        
        function resetZoom() {
            if (mapBounds) {
                // Calculate appropriate zoom level for bounds
                const latDiff = mapBounds.maxLat - mapBounds.minLat;
                const lonDiff = mapBounds.maxLon - mapBounds.minLon;
                const maxDiff = Math.max(latDiff, lonDiff);
                
                if (maxDiff > 50) currentZoom = 3;
                else if (maxDiff > 20) currentZoom = 4;
                else if (maxDiff > 10) currentZoom = 5;
                else if (maxDiff > 5) currentZoom = 6;
                else currentZoom = 7;
                
                currentCenter = {
                    lat: (mapBounds.minLat + mapBounds.maxLat) / 2,
                    lon: (mapBounds.minLon + mapBounds.maxLon) / 2
                };
            } else {
                currentZoom = 4;
                currentCenter = {lat: 39.8283, lon: -98.5795};
            }
            updatePlotlyZoom();
        }
        
        function updatePlotlyZoom() {
            const update = {
                'mapbox.zoom': currentZoom,
                'mapbox.center': currentCenter
            };
            
            if (currentMapType !== 'choropleth') {
                Plotly.relayout('plotly-map', update);
            }
        }
        
        function createLeafletMap(data) {
            // Initialize map if not exists
            if (!leafletMap) {
                leafletMap = L.map('leaflet-map').setView([39.8283, -98.5795], 4);
                
                // Add tile layer based on current theme
                const tileUrl = currentTheme === 'dark' 
                    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                    : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                
                L.tileLayer(tileUrl, {
                    attribution: '© OpenStreetMap contributors © CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(leafletMap);
            }
            
            // Clear existing markers
            if (leafletMarkers) {
                leafletMap.removeLayer(leafletMarkers);
            }
            
            // Create marker cluster group
            leafletMarkers = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    const size = count < 10 ? 40 : count < 100 ? 50 : 60;
                    
                    return L.divIcon({
                        html: `<div style="
                            background: #ED1B2E;
                            border: 3px solid #27ae60;
                            width: ${size}px;
                            height: ${size}px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                            font-size: ${size < 50 ? '14px' : '16px'};
                        ">${count}</div>`,
                        className: 'custom-cluster-icon',
                        iconSize: L.point(size, size)
                    });
                },
                maxClusterRadius: 80,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true
            });
            
            // Add markers to cluster group
            data.forEach(d => {
                if (d.lat && d.lon) {
                    const marker = L.marker([d.lat, d.lon], {
                        icon: L.divIcon({
                            html: `<div style="
                                background: #ED1B2E;
                                width: 10px;
                                height: 10px;
                                border-radius: 50%;
                                border: 2px solid white;
                            "></div>`,
                            className: 'custom-marker',
                            iconSize: L.point(10, 10)
                        })
                    });
                    
                    marker.bindPopup(`
                        <div style="font-family: 'Open Sans', sans-serif;">
                            <strong>${d.city}, ${d.state}</strong><br>
                            Gift: $${d.gift_amount.toLocaleString()}<br>
                            Donor #: ${d['Donor #']}
                        </div>
                    `);
                    
                    leafletMarkers.addLayer(marker);
                }
            });
            
            // Add cluster group to map
            leafletMap.addLayer(leafletMarkers);
            
            // Fit bounds if we have data
            if (data.length > 0) {
                const bounds = leafletMarkers.getBounds();
                if (bounds.isValid()) {
                    leafletMap.fitBounds(bounds, {padding: [50, 50]});
                }
            }
        }
        
        function createClusterMap(data) {
            const hoverText = data.map(d => 
                `<b>${d.city}, ${d.state}</b><br>` +
                `Gift: $${d.gift_amount.toLocaleString()}<br>` +
                `Donor #: ${d['Donor #']}`
            );
            
            const trace = {
                type: 'scattermapbox',
                lon: data.map(d => d.lon),
                lat: data.map(d => d.lat),
                mode: 'markers',
                marker: {
                    size: 10,
                    color: data.map(d => d.gift_amount),
                    colorscale: [
                        [0, '#FFE6E8'],
                        [0.2, '#FFB3B8'],
                        [0.4, '#FF8088'],
                        [0.6, '#FF4D58'],
                        [0.8, '#ED1B2E'],
                        [1, '#8B1A1E']
                    ],
                    showscale: true,
                    colorbar: {
                        title: 'Gift Amount',
                        titlefont: {color: RED_CROSS_COLORS.dark_red},
                        tickfont: {color: RED_CROSS_COLORS.gray},
                        tickprefix: '$',
                        tickformat: ',.0f'
                    },
                    opacity: 0.8
                },
                text: hoverText,
                hovertemplate: '%{text}<extra></extra>',
                cluster: {
                    enabled: true,
                    size: 40,
                    step: 1,
                    color: ['#FFE6E8', '#FFB3B8', '#FF8088', '#FF4D58', '#ED1B2E', '#B31E29', '#8B1A1E'],
                    opacity: 0.8,
                    maxzoom: 10
                }
            };
            
            const layout = {
                mapbox: {
                    style: currentTheme === 'dark' ? 'carto-darkmatter' : 'carto-positron',
                    center: {
                        lat: currentCenter.lat || 39.8283,
                        lon: currentCenter.lon || -98.5795
                    },
                    zoom: currentZoom || 4 || 4
                },
                height: 700,
                margin: {r:0, t:40, l:0, b:0},
                title: {
                    text: 'American Red Cross Donor Map',
                    font: {size: 24, color: RED_CROSS_COLORS.primary_red, family: 'Arial, sans-serif'}
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['select2d', 'lasso2d'],
                doubleClick: 'reset+autosize',
                scrollZoom: true
            };
            
            Plotly.newPlot('plotly-map', [trace], layout, config);
            
            // Update zoom tracking on interaction
            document.getElementById('plotly-map').on('plotly_relayout', function(eventdata) {
                if (eventdata['mapbox.zoom']) {
                    currentZoom = eventdata['mapbox.zoom'];
                }
                if (eventdata['mapbox.center']) {
                    currentCenter = eventdata['mapbox.center'];
                }
            });
        }
        
        function createHeatmap(data) {
            const trace = {
                type: 'densitymapbox',
                lat: data.map(d => d.lat),
                lon: data.map(d => d.lon),
                z: data.map(d => d.gift_amount),
                radius: 20,
                colorscale: [
                    [0, RED_CROSS_COLORS.white],
                    [0.2, '#FFE6E8'],
                    [0.4, '#FFB3B8'],
                    [0.6, '#FF8088'],
                    [0.8, RED_CROSS_COLORS.primary_red],
                    [1, RED_CROSS_COLORS.dark_red]
                ],
                showscale: true,
                colorbar: {
                    title: 'Gift Amount',
                    titlefont: {color: RED_CROSS_COLORS.dark_red},
                    tickfont: {color: RED_CROSS_COLORS.gray},
                    tickprefix: '$'
                }
            };
            
            const layout = {
                mapbox: {
                    style: currentTheme === 'dark' ? 'carto-darkmatter' : 'carto-positron',
                    center: {
                        lat: currentCenter.lat || 39.8283,
                        lon: currentCenter.lon || -98.5795
                    },
                    zoom: currentZoom || 4
                },
                height: 700,
                margin: {r:0, t:40, l:0, b:0},
                title: {
                    text: 'American Red Cross Donor Heatmap',
                    font: {size: 24, color: RED_CROSS_COLORS.primary_red, family: 'Arial, sans-serif'}
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['select2d', 'lasso2d'],
                doubleClick: 'reset+autosize',
                scrollZoom: true
            };
            
            Plotly.newPlot('plotly-map', [trace], layout, config);
            
            // Update zoom tracking on interaction
            document.getElementById('plotly-map').on('plotly_relayout', function(eventdata) {
                if (eventdata['mapbox.zoom']) {
                    currentZoom = eventdata['mapbox.zoom'];
                }
                if (eventdata['mapbox.center']) {
                    currentCenter = eventdata['mapbox.center'];
                }
            });
        }
        
        function createChoropleth(data) {
            const stateData = {};
            data.forEach(d => {
                if (!stateData[d.state]) {
                    stateData[d.state] = {total: 0, count: 0};
                }
                stateData[d.state].total += d.gift_amount;
                stateData[d.state].count += 1;
            });
            
            const states = Object.keys(stateData);
            const totals = states.map(s => stateData[s].total);
            const text = states.map(s => 
                `${s}<br>Donors: ${stateData[s].count.toLocaleString()}<br>Total: $${stateData[s].total.toLocaleString()}`
            );
            
            const trace = {
                type: 'choropleth',
                locationmode: 'USA-states',
                locations: states,
                z: totals,
                text: text,
                hovertemplate: '%{text}<extra></extra>',
                colorscale: [
                    [0, RED_CROSS_COLORS.white],
                    [0.2, '#FFE6E8'],
                    [0.4, '#FFB3B8'],
                    [0.6, '#FF8088'],
                    [0.8, RED_CROSS_COLORS.primary_red],
                    [1, RED_CROSS_COLORS.dark_red]
                ],
                colorbar: {
                    title: 'Total Donations',
                    titlefont: {color: RED_CROSS_COLORS.dark_red},
                    tickfont: {color: RED_CROSS_COLORS.gray},
                    tickprefix: '$'
                }
            };
            
            const layout = {
                geo: {
                    scope: 'usa',
                    projection: {type: 'albers usa'},
                    showlakes: true,
                    lakecolor: 'rgb(255, 255, 255)'
                },
                height: 700,
                margin: {r:0, t:60, l:0, b:0},
                title: {
                    text: 'American Red Cross Donations by State',
                    font: {size: 24, color: RED_CROSS_COLORS.primary_red, family: 'Arial, sans-serif'}
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['select2d', 'lasso2d'],
                doubleClick: 'reset+autosize',
                scrollZoom: true
            };
            
            Plotly.newPlot('plotly-map', [trace], layout, config);
            
            // Update zoom tracking on interaction
            document.getElementById('plotly-map').on('plotly_relayout', function(eventdata) {
                if (eventdata['mapbox.zoom']) {
                    currentZoom = eventdata['mapbox.zoom'];
                }
                if (eventdata['mapbox.center']) {
                    currentCenter = eventdata['mapbox.center'];
                }
            });
        }
        
        function createPointMap(data) {
            const trace = {
                type: 'scattermapbox',
                lon: data.map(d => d.lon),
                lat: data.map(d => d.lat),
                mode: 'markers',
                marker: {
                    size: 6,
                    color: RED_CROSS_COLORS.primary_red,
                    opacity: 0.7
                },
                text: data.map(d => `${d.city}, ${d.state}<br>$${d.gift_amount.toLocaleString()}`),
                hovertemplate: '%{text}<extra></extra>'
            };
            
            const layout = {
                mapbox: {
                    style: currentTheme === 'dark' ? 'carto-darkmatter' : 'carto-positron',
                    center: {
                        lat: currentCenter.lat || 39.8283,
                        lon: currentCenter.lon || -98.5795
                    },
                    zoom: currentZoom || 4
                },
                height: 700,
                margin: {r:0, t:40, l:0, b:0},
                title: {
                    text: 'American Red Cross Donor Locations',
                    font: {size: 24, color: RED_CROSS_COLORS.primary_red, family: 'Arial, sans-serif'}
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['select2d', 'lasso2d'],
                doubleClick: 'reset+autosize',
                scrollZoom: true
            };
            
            Plotly.newPlot('plotly-map', [trace], layout, config);
            
            // Update zoom tracking on interaction
            document.getElementById('plotly-map').on('plotly_relayout', function(eventdata) {
                if (eventdata['mapbox.zoom']) {
                    currentZoom = eventdata['mapbox.zoom'];
                }
                if (eventdata['mapbox.center']) {
                    currentCenter = eventdata['mapbox.center'];
                }
            });
        }
        
        function updateCharts(data) {
            return; // Charts disabled for now to maximize map space
            // Top states chart
            const stateData = {};
            data.forEach(d => {
                if (!stateData[d.state]) stateData[d.state] = 0;
                stateData[d.state] += d.gift_amount;
            });
            
            const sortedStates = Object.entries(stateData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const stateTrace = {
                x: sortedStates.map(s => s[0]),
                y: sortedStates.map(s => s[1]),
                type: 'bar',
                marker: {color: RED_CROSS_COLORS.primary_red, opacity: 0.8},
                text: sortedStates.map(s => '$' + s[1].toLocaleString()),
                textposition: 'auto',
                hovertemplate: '%{x}<br>$%{y:,.0f}<extra></extra>'
            };
            
            const stateLayout = {
                height: 250,
                margin: {t: 10, b: 40, l: 60, r: 20},
                xaxis: {tickangle: -45},
                yaxis: {title: 'Total Donations ($)', tickformat: '$,.0f'},
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };
            
            Plotly.newPlot('top-states-chart', [stateTrace], stateLayout, {responsive: true, displayModeBar: false});
            
            // Gift distribution chart
            const categoryCount = {};
            data.forEach(d => {
                if (!categoryCount[d.gift_category]) categoryCount[d.gift_category] = 0;
                categoryCount[d.gift_category]++;
            });
            
            const categories = ['$5K', '$5K-7.5K', '$7.5K-10K', '$10K-15K', '$15K-25K', '$25K-50K', '$50K-100K', '>$100K'];
            const counts = categories.map(c => categoryCount[c] || 0);
            
            const pieTrace = {
                labels: categories.filter((c, i) => counts[i] > 0),
                values: counts.filter(c => c > 0),
                type: 'pie',
                marker: {colors: categories.filter((c, i) => counts[i] > 0).map(c => GIFT_COLORS[c])},
                textinfo: 'label+percent',
                hovertemplate: '%{label}<br>%{value} donors<br>%{percent}<extra></extra>'
            };
            
            const pieLayout = {
                height: 250,
                margin: {t: 10, b: 10, l: 10, r: 10},
                paper_bgcolor: 'rgba(0,0,0,0)',
                showlegend: true,
                legend: {orientation: 'v', x: 1, y: 0.5}
            };
            
            Plotly.newPlot('gift-distribution-chart', [pieTrace], pieLayout, {responsive: true, displayModeBar: false});
        }
        
        function resetFilters() {
            document.getElementById('state-filter').value = 'all';
            document.getElementById('city-filter').value = 'all';
            document.getElementById('gift-category').value = 'all';
            document.getElementById('min-gift').value = '5000';
            document.getElementById('max-gift').value = '';
            applyFilters();
        }
        
        document.getElementById('state-filter').addEventListener('change', function() {
            if (this.value !== 'all') {
                document.getElementById('city-filter').value = 'all';
                applyFilters();
            }
        });
        
        // Load data when page loads
        loadCSVData();
    </script>
</body>
</html>